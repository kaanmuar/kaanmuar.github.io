<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Admin Panel - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn { position: relative; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { background-color: #0891b2; color: white; }
        .tab-btn:not(.active) { background-color: #e5e7eb; color: #4b5563; }
        .item-card { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status-dot, .new-indicator { width: 10px; height: 10px; border-radius: 50%; }
        .status-pending { background-color: #f59e0b; }
        .status-approved { background-color: #10b981; }
        .status-rejected { background-color: #ef4444; }
        .new-indicator { background-color: #3b82f6; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .login-box { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px; }
        .filter-container { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .filter-container input, .filter-container select {
            border-radius: 6px; border: 1px solid #d1d5db; padding: 0.5rem; width: 100%;
        }
        .filter-label { font-weight: 500; font-size: 0.875rem; color: #4b5563; }
        .bulk-actions-container { position: relative; display: inline-block; }
        .bulk-actions-dropdown {
            display: none; position: absolute; background-color: white;
            min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1; border-radius: 8px; padding: 0.5rem 0; right: 0;
        }
        .bulk-actions-dropdown a { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
        .bulk-actions-dropdown a:hover { background-color: #f1f1f1; }
        .show-dropdown { display: block; }
        .title-container { display: flex; align-items: center; gap: 0.75rem; }
        /* NEW: Response Modal Styles */
        #response-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        #response-modal-overlay.visible { display: flex; }
        .response-modal-box {
            background-color: white; padding: 1.5rem; border-radius: 8px;
            width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .response-modal-box textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; min-height: 120px; }
        .responded-badge {
            background-color: #e0e7ff; color: #4338ca; font-size: 0.7rem; font-weight: 600;
            padding: 2px 8px; border-radius: 9999px; display: inline-flex; align-items: center; gap: 4px;
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
        <form id="login-form"><div class="mb-4"><label for="email" class="block font-medium mb-1">Email</label><input type="email" id="email" required class="w-full p-2 border border-gray-300 rounded-md"></div><div class="mb-4"><label for="password" class="block font-medium mb-1">Password</label><input type="password" id="password" required class="w-full p-2 border border-gray-300 rounded-md"></div><button type="submit" class="w-full bg-cyan-600 text-white p-2 rounded-md font-bold hover:bg-cyan-700">Login</button><p id="login-error" class="text-red-600 text-sm mt-2"></p></form>
    </div>
</div>

<main id="dashboard" class="container mx-auto p-4 md:p-6 hidden">
    <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">CV Admin Dashboard</h1><button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">Logout</button></div>

    <div class="flex flex-wrap gap-2 mb-6 border-b pb-2">
        <button id="messages-tab-btn" class="tab-btn active">Messages</button>
        <button id="ratings-tab-btn" class="tab-btn">CV Ratings</button>
        <button id="rejected-tab-btn" class="tab-btn">Rejected Messages</button>
        <button id="blocked-tab-btn" class="tab-btn">Blocked Senders</button>
        <button id="stats-tab-btn" class="tab-btn">Statistics</button>
    </div>

    <!-- Messages Pane -->
    <div id="messages-pane">
        <div class="flex justify-between items-center mb-4">
            <div class="title-container"><h2 class="text-2xl font-semibold">Inbox Messages</h2><span id="messages-count" class="font-medium text-gray-500"></span></div>
            <div id="messages-bulk-actions" class="bulk-actions-container"></div>
        </div>
        <div class="filter-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div><label class="filter-label" for="msg-filter-name">Name</label><input type="text" id="msg-filter-name" placeholder="Filter by Name..."></div>
                <div><label class="filter-label" for="msg-filter-email">Email</label><input type="email" id="msg-filter-email" placeholder="Filter by Email..."></div>
                <div><label class="filter-label" for="msg-filter-topic-select">Topic</label><select id="msg-filter-topic-select"></select></div>
                <div id="msg-other-topic-container" class="hidden"><label class="filter-label" for="msg-filter-topic-other">Other Topic</label><input type="text" id="msg-filter-topic-other" placeholder="Enter topic..."></div>
                <div><label class="filter-label" for="msg-filter-date-start">Date Range</label><div class="flex gap-2"><input type="date" id="msg-filter-date-start"><input type="date" id="msg-filter-date-end"></div></div>
                <div><label id="msg-filter-attachment-label" class="filter-label" for="msg-filter-attachment">Attachment</label><select id="msg-filter-attachment"></select></div>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="filter-reset-btn text-sm font-semibold py-2 px-4 rounded-md hover:bg-gray-200">Reset</button>
                <button class="filter-apply-btn bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Apply Filters</button>
            </div>
        </div>
        <div id="messages-list" class="space-y-4"></div>
    </div>

    <!-- CV Ratings Pane -->
    <div id="ratings-pane" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <div class="title-container"><h2 class="text-2xl font-semibold">CV Ratings</h2><div id="ratings-new-indicator" class="hidden new-indicator"></div><span id="ratings-count" class="font-medium text-gray-500"></span></div>
            <div id="ratings-bulk-actions" class="bulk-actions-container"></div>
        </div>
        <div class="filter-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div><label class="filter-label" for="rate-filter-name">Name</label><input type="text" id="rate-filter-name" placeholder="Filter by Name..."></div>
                <div><label class="filter-label" for="rate-filter-email">Email</label><input type="email" id="rate-filter-email" placeholder="Filter by Email..."></div>
                <div><label class="filter-label" for="rate-filter-date-start">Date Range</label><div class="flex gap-2"><input type="date" id="rate-filter-date-start"><input type="date" id="rate-filter-date-end"></div></div>
                <div><label id="rate-filter-rate-label" class="filter-label" for="rate-filter-rate">Rating</label><select id="rate-filter-rate"></select></div>
                <div><label id="rate-filter-status-label" class="filter-label" for="rate-filter-status">Status</label><select id="rate-filter-status"></select></div>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="filter-reset-btn text-sm font-semibold py-2 px-4 rounded-md hover:bg-gray-200">Reset</button>
                <button class="filter-apply-btn bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Apply Filters</button>
            </div>
        </div>
        <div id="ratings-list" class="space-y-4"></div>
    </div>

    <!-- Other Panes (Rejected, Blocked, Stats) -->
    <div id="rejected-pane" class="hidden">
        <div class="flex justify-between items-center mb-4"><div class="title-container"><h2 class="text-2xl font-semibold">Rejected Messages</h2><span id="rejected-count" class="font-medium text-gray-500"></span></div></div>
        <div class="filter-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div><label class="filter-label" for="rej-filter-name">Name</label><input type="text" id="rej-filter-name" placeholder="Filter by Name..."></div>
                <div><label class="filter-label" for="rej-filter-email">Email</label><input type="email" id="rej-filter-email" placeholder="Filter by Email..."></div>
                <div><label class="filter-label" for="rej-filter-date-start">Rejection Date</label><div class="flex gap-2"><input type="date" id="rej-filter-date-start"><input type="date" id="rej-filter-date-end"></div></div>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="filter-reset-btn text-sm font-semibold py-2 px-4 rounded-md hover:bg-gray-200">Reset</button>
                <button class="filter-apply-btn bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Apply Filters</button>
            </div>
        </div>
        <div id="rejected-list" class="space-y-4"></div>
    </div>
    <div id="blocked-pane" class="hidden">
        <div class="flex justify-between items-center mb-4"><div class="title-container"><h2 class="text-2xl font-semibold">Blocked Senders</h2><span id="blocked-count" class="font-medium text-gray-500"></span></div></div>
        <div class="filter-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div><label class="filter-label" for="block-filter-email">Email</label><input type="email" id="block-filter-email" placeholder="Filter by Email..."></div>
                <div><label class="filter-label" for="block-filter-date-start">Blocked Date</label><div class="flex gap-2"><input type="date" id="block-filter-date-start"><input type="date" id="block-filter-date-end"></div></div>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="filter-reset-btn text-sm font-semibold py-2 px-4 rounded-md hover:bg-gray-200">Reset</button>
                <button class="filter-apply-btn bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Apply Filters</button>
            </div>
        </div>
        <div id="blocked-list" class="space-y-4"></div>
    </div>
    <div id="stats-pane" class="hidden">
        <h2 class="text-2xl font-semibold mb-4">Platform Statistics</h2>
        <div class="filter-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div><label class="filter-label" for="stats-date-start">Date Range</label><div class="flex gap-2"><input type="date" id="stats-date-start"><input type="date" id="stats-date-end"></div></div>
            <div><label class="filter-label" for="stats-chart-type">Chart Type</label><select id="stats-chart-type"><option value="bar">Bar</option><option value="line">Line</option></select></div>
            <div><label class="filter-label" for="stats-data-select">Data</label><select id="stats-data-select" multiple size="4" class="h-auto"></select></div>
            <button id="stats-apply-btn" class="bg-cyan-600 text-white p-2 rounded-md font-bold hover:bg-cyan-700 h-10">Apply</button>
        </div>
        <div class="bg-white p-4 rounded-lg shadow"><canvas id="stats-chart"></canvas></div>
    </div>
</main>

<!-- NEW: Response Modal -->
<div id="response-modal-overlay">
    <div class="response-modal-box">
        <form id="response-form">
            <h3 class="text-xl font-bold mb-2">Respond to <span id="response-recipient-name"></span></h3>
            <p class="text-sm text-gray-500 mb-4">Recipient: <span id="response-recipient-email"></span></p>
            <div class="mb-4">
                <label for="response-message" class="block font-medium mb-1">Your Response:</label>
                <textarea id="response-message" required minlength="10"></textarea>
                <p class="text-xs text-gray-500 mt-1">This response will be saved to the database. A backend function would be needed to trigger an actual email.</p>
            </div>
            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" id="response-is-public" class="h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                    <span class="ml-2 text-sm text-gray-700">Make this response public</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">If checked, the original comment and your response will appear on the CV's Testimonials section.</p>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="response-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" id="response-send-btn" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Send Response</button>
            </div>
        </form>
    </div>
</div>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    // MODIFIED: Added addDoc for new testimonial creation
    import { getFirestore, collection, query, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = { apiKey: "AIzaSyA2-6WkecV3GoAK4qlsdGtH3jisjk3bK0w", authDomain: "carlosm-interactive-cv.firebaseapp.com", projectId: "carlosm-interactive-cv", storageBucket: "carlosm-interactive-cv.firebasestorage.app", messagingSenderId: "976558418058", appId: "1:976558418058:web:1dc19bcd40915ea233e573" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global State
    let allMessages = [], allRatings = [], allBlockedSenders = [];
    let statsChart = null;
    const MESSAGE_TOPICS = ["General Inquiry", "Job Opportunity", "Collaboration", "Feedback", "Other"];

    // DOM Elements
    const loginOverlay = document.getElementById('login-overlay'), dashboard = document.getElementById('dashboard'), logoutBtn = document.getElementById('logout-btn');
    const tabButtons = { messages: document.getElementById('messages-tab-btn'), ratings: document.getElementById('ratings-tab-btn'), rejected: document.getElementById('rejected-tab-btn'), blocked: document.getElementById('blocked-tab-btn'), stats: document.getElementById('stats-tab-btn') };
    const panes = { messages: document.getElementById('messages-pane'), ratings: document.getElementById('ratings-pane'), rejected: document.getElementById('rejected-pane'), blocked: document.getElementById('blocked-pane'), stats: document.getElementById('stats-pane') };
    const lists = { messages: document.getElementById('messages-list'), ratings: document.getElementById('ratings-list'), rejected: document.getElementById('rejected-list'), blocked: document.getElementById('blocked-list') };
    // NEW: Response Modal Elements
    const responseModalOverlay = document.getElementById('response-modal-overlay');
    const responseForm = document.getElementById('response-form');
    let currentResponseData = {};

    // --- Auth ---
    onAuthStateChanged(auth, user => { if (user) { loginOverlay.style.display = 'none'; dashboard.classList.remove('hidden'); initDashboard(); } else { loginOverlay.style.display = 'flex'; dashboard.classList.add('hidden'); } });
    document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value).catch(err => { document.getElementById('login-error').textContent = "Login failed."; console.error(err); }); });
    logoutBtn.addEventListener('click', () => signOut(auth));

    // --- Init ---
    function initDashboard() {
        Object.keys(tabButtons).forEach(key => tabButtons[key].addEventListener('click', () => switchTab(key)));
        loadAllData();
        setupFilterListeners();
        setupBulkActionButtons();
        populateStaticDropdowns();
        // NEW: Setup modal listeners
        setupModalListeners();
    }

    function switchTab(tabKey) {
        Object.keys(panes).forEach(key => {
            const isActive = key === tabKey;
            tabButtons[key].classList.toggle('active', isActive);
            panes[key].classList.toggle('hidden', !isActive);
        });
        if (tabKey === 'stats') renderStatisticsGraph();
    }

    function populateStaticDropdowns() {
        const topicSelect = document.getElementById('msg-filter-topic-select');
        topicSelect.innerHTML = `<option value="">All Topics</option>` + MESSAGE_TOPICS.map(t => `<option value="${t}">${t}</option>`).join('');

        document.getElementById('msg-filter-attachment').innerHTML = `<option value="">Any Attachment</option><option value="yes">With Attachments</option><option value="no">No Attachments</option>`;
        document.getElementById('rate-filter-rate').innerHTML = `<option value="">Any Rate</option>` + [5,4,3,2,1].map(n => `<option value="${n}">${n} Stars</option>`).join('');
        document.getElementById('rate-filter-status').innerHTML = `<option value="">Any Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option>`;

        const statsDataSelect = document.getElementById('stats-data-select');
        statsDataSelect.innerHTML = `<option value="messages" selected>New Messages</option><option value="ratings" selected>New CV Ratings</option><option value="rejected">Rejected Messages</option><option value="blocked">Blocked Senders</option>`;
    }

    // --- Data Loading ---
    function loadAllData() {
        const initialLoad = (snap, targetArray, callback) => {
            targetArray.splice(0, targetArray.length, ...snap.docs.map(d => ({ id: d.id, ...d.data() })));
            callback();
        };

        onSnapshot(collection(db, "blocked_senders"), snap => initialLoad(snap, allBlockedSenders, applyAllFilters));
        onSnapshot(query(collection(db, "messages")), snap => initialLoad(snap, allMessages, applyAllFilters));
        onSnapshot(query(collection(db, "ratings")), snap => initialLoad(snap, allRatings, applyAllFilters));
    }

    // --- Filtering Logic ---
    function setupFilterListeners() {
        document.querySelectorAll('.filter-apply-btn').forEach(btn => btn.addEventListener('click', applyAllFilters));
        document.querySelectorAll('.filter-reset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filterContainer = e.target.closest('.filter-container');
                filterContainer.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                // Also reset the 'Other' topic field if it exists
                const otherTopicContainer = filterContainer.querySelector('#msg-other-topic-container');
                if (otherTopicContainer) {
                    otherTopicContainer.classList.add('hidden');
                }
                applyAllFilters();
            });
        });

        document.getElementById('msg-filter-topic-select').addEventListener('change', e => {
            document.getElementById('msg-other-topic-container').classList.toggle('hidden', e.target.value !== 'Other');
        });
        document.getElementById('stats-apply-btn').addEventListener('click', renderStatisticsGraph);
    }

    function applyAllFilters() {
        const blockedEmails = allBlockedSenders.map(u => u.id);
        const inboxMessages = allMessages.filter(m => m.status !== 'rejected' && !blockedEmails.includes(m.email.toLowerCase()));
        const rejectedMessages = allMessages.filter(m => m.status === 'rejected');

        filterAndRender(inboxMessages, filterMessageCard, lists.messages, document.getElementById('messages-count'));
        filterAndRender(allRatings.filter(r => !blockedEmails.includes(r.email.toLowerCase())), filterRatingCard, lists.ratings, document.getElementById('ratings-count'));
        filterAndRender(rejectedMessages, filterRejectedMessageCard, lists.rejected, document.getElementById('rejected-count'));
        filterAndRender(allBlockedSenders, filterBlockedSenderCard, lists.blocked, document.getElementById('blocked-count'));

        updateFilterCounts(inboxMessages, allRatings);
        updateNewIndicators();
    }

    function filterAndRender(items, filterFn, container, countEl) {
        const filtered = items.filter(item => filterFn(item, false)); // Pass false to filter
        if (countEl) countEl.textContent = `(${filtered.length} / ${items.length})`;
        renderList(container, filtered, (item) => filterFn(item, true)); // Pass true to get renderer
    }

    const dateInRange = (dateStr, startStr, endStr) => {
        if (!dateStr) return false;
        const date = new Date(dateStr);
        if (startStr && date < new Date(startStr)) return false;
        if (endStr) {
            const endDate = new Date(endStr);
            endDate.setHours(23, 59, 59, 999); // Include the whole end day
            if (date > endDate) return false;
        }
        return true;
    };

    function filterMessageCard(msg, forRender = false) {
        if (forRender) return renderMessageCard(msg);
        const name = document.getElementById('msg-filter-name').value.toLowerCase();
        const email = document.getElementById('msg-filter-email').value.toLowerCase();
        const topicSelect = document.getElementById('msg-filter-topic-select').value;
        const topicOther = document.getElementById('msg-filter-topic-other').value.toLowerCase();
        const dateStart = document.getElementById('msg-filter-date-start').value;
        const dateEnd = document.getElementById('msg-filter-date-end').value;
        const attachment = document.getElementById('msg-filter-attachment').value;

        const msgDate = msg.createdAt ? msg.createdAt.toDate().toISOString().split('T')[0] : '';
        let topicMatch = true;
        if (topicSelect) {
            if (topicSelect === 'Other') topicMatch = msg.topic.toLowerCase().includes(topicOther);
            else topicMatch = msg.topic === topicSelect;
        }

        return (!name || msg.name.toLowerCase().includes(name)) &&
            (!email || msg.email.toLowerCase().includes(email)) &&
            topicMatch &&
            dateInRange(msgDate, dateStart, dateEnd) &&
            (attachment === '' || (attachment === 'yes' && msg.fileURL) || (attachment === 'no' && !msg.fileURL));
    }

    function filterRatingCard(r, forRender = false) {
        if (forRender) return renderRatingCard(r);
        const name = document.getElementById('rate-filter-name').value.toLowerCase();
        const email = document.getElementById('rate-filter-email').value.toLowerCase();
        const dateStart = document.getElementById('rate-filter-date-start').value;
        const dateEnd = document.getElementById('rate-filter-date-end').value;
        const rate = document.getElementById('rate-filter-rate').value;
        const status = document.getElementById('rate-filter-status').value;

        const rDate = r.createdAt ? r.createdAt.toDate().toISOString().split('T')[0] : '';
        return (!name || r.name.toLowerCase().includes(name)) &&
            (!email || r.email.toLowerCase().includes(email)) &&
            dateInRange(rDate, dateStart, dateEnd) &&
            (!rate || r.rating.toString() === rate) &&
            (!status || r.status === status);
    }

    function filterRejectedMessageCard(msg, forRender = false) {
        if (forRender) return renderRejectedMessageCard(msg);
        const name = document.getElementById('rej-filter-name').value.toLowerCase();
        const email = document.getElementById('rej-filter-email').value.toLowerCase();
        const dateStart = document.getElementById('rej-filter-date-start').value;
        const dateEnd = document.getElementById('rej-filter-date-end').value;
        const rejDate = msg.rejectedAt ? msg.rejectedAt.toDate().toISOString().split('T')[0] : '';
        return (!name || msg.name.toLowerCase().includes(name)) &&
            (!email || msg.email.toLowerCase().includes(email)) &&
            dateInRange(rejDate, dateStart, dateEnd);
    }

    function filterBlockedSenderCard(user, forRender = false) {
        if (forRender) return renderBlockedSenderCard(user);
        const email = document.getElementById('block-filter-email').value.toLowerCase();
        const dateStart = document.getElementById('block-filter-date-start').value;
        const dateEnd = document.getElementById('block-filter-date-end').value;
        const blockDate = user.blockedAt ? user.blockedAt.toDate().toISOString().split('T')[0] : '';
        return (!email || user.id.toLowerCase().includes(email)) &&
            dateInRange(blockDate, dateStart, dateEnd);
    }

    function updateFilterCounts(messages, ratings) {
        const attachmentCounts = { yes: messages.filter(m => m.fileURL).length, no: messages.filter(m => !m.fileURL).length };
        document.getElementById('msg-filter-attachment-label').textContent = `Attachment (Yes: ${attachmentCounts.yes}, No: ${attachmentCounts.no})`;

        const ratingCounts = ratings.reduce((acc, r) => { acc[r.rating] = (acc[r.rating] || 0) + 1; return acc; }, {});
        document.getElementById('rate-filter-rate-label').textContent = `Rating (${Object.entries(ratingCounts).map(([k,v]) => `${k}*: ${v}`).join(', ')})`;

        const statusCounts = ratings.reduce((acc, r) => { acc[r.status] = (acc[r.status] || 0) + 1; return acc; }, {});
        document.getElementById('rate-filter-status-label').textContent = `Status (${Object.entries(statusCounts).map(([k,v]) => `${k}: ${v}`).join(', ')})`;
    }

    function updateNewIndicators() {
        const hasPending = allRatings.some(r => r.status === 'pending');
        document.getElementById('ratings-new-indicator').classList.toggle('hidden', !hasPending);
    }

    // --- Rendering ---
    function renderList(container, items, renderer) {
        container.innerHTML = items.length ? items.map(renderer).join('') : '<p class="text-center text-gray-500 py-4">No items to display.</p>';
        addCardEventListeners();
    }

    function createCardHTML(doc, content, actions) {
        const respondedBadge = doc.response ? `<div class="responded-badge"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Responded</div>` : '';
        return `<div class="item-card p-4 flex gap-4 items-start"><input type="checkbox" class="bulk-checkbox mt-2" data-id="${doc.id}" data-email="${doc.email}" data-status="${doc.status || ''}"><div class="flex-grow">${content}<div class="flex items-center flex-wrap gap-2 mt-4">${actions}${respondedBadge}</div></div></div>`;
    }

    function renderMessageCard(msg) {
        const date = msg.createdAt ? msg.createdAt.toDate().toLocaleString() : 'N/A';
        const content = `<div class="flex justify-between items-start mb-2"><div><p class="font-bold text-lg">${msg.name} <span class="font-normal text-sm text-gray-500">&lt;${msg.email}&gt;</span></p><p class="text-sm text-gray-600"><strong>Topic:</strong> ${msg.topic}</p></div><span class="text-xs text-gray-500 mb-2">${date}</span></div><p class="text-gray-700 whitespace-pre-wrap p-2 bg-gray-50 rounded-md mb-2">${msg.message}</p><p class="text-sm">${msg.fileURL ? `<a href="${msg.fileURL}" target="_blank" class="text-cyan-600 hover:underline">View Attachment</a>` : 'No attachment'}</p>`;
        const actions = `<button data-action="respond" data-type="message" data-id="${msg.id}" class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">Respond</button><button data-action="reject-msg" data-id="${msg.id}" class="bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-yellow-600">Reject</button><button data-action="block" data-email="${msg.email}" class="bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-red-600">Block Sender</button>`;
        return createCardHTML(msg, content, actions);
    }

    function renderRatingCard(r) {
        const date = r.createdAt ? r.createdAt.toDate().toLocaleString() : 'N/A';
        const stars = '&#9733;'.repeat(r.rating) + '&#9734;'.repeat(5 - r.rating);
        let actions = `<button data-action="respond" data-type="rating" data-id="${r.id}" class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">Respond</button>`;
        if (r.status === 'pending') actions += `<button data-action="approve" data-id="${r.id}" class="bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-green-600">Approve</button><button data-action="approve-anon" data-id="${r.id}" class="bg-sky-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-sky-600">Approve Anonymously</button><button data-action="reject" data-id="${r.id}" class="bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-yellow-600">Reject</button>`;
        else if (r.status === 'approved') actions += `<button data-action="retract" data-id="${r.id}" class="bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-gray-600">Retract</button>`;
        else if (r.status === 'rejected') actions += `<button data-action="restore" data-id="${r.id}" class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">Restore</button>`;
        actions += `<button data-action="block" data-email="${r.email}" class="bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-red-600">Block Sender</button>`;
        const content = `<div class="flex justify-between items-start mb-2"><div><p class="font-bold text-lg">${r.name} <span class="font-normal text-sm text-gray-500">&lt;${r.email}&gt;</span></p><p class="text-xl text-yellow-400">${stars}</p></div><div class="text-right"><div class="flex items-center gap-2 mb-1"><span class="status-dot status-${r.status}"></span><span class="text-sm font-medium capitalize">${r.status}</span></div><span class="text-xs text-gray-500 mb-2 block">${date}</span></div></div>${r.comment ? `<p class="text-gray-700 whitespace-pre-wrap p-2 bg-gray-50 rounded-md mt-2">${r.comment}</p>` : ''}`;
        return createCardHTML(r, content, actions);
    }

    function renderRejectedMessageCard(msg) {
        const date = msg.rejectedAt ? `Rejected: ${msg.rejectedAt.toDate().toLocaleString()}` : 'N/A';
        const content = `<div class="flex justify-between items-start mb-2"><p class="font-bold text-lg">${msg.name} <span class="font-normal text-sm text-gray-500">&lt;${msg.email}&gt;</span></p><span class="text-xs text-gray-500">${date}</span></div><p class="text-gray-700 whitespace-pre-wrap p-2 bg-gray-50 rounded-md">${msg.message}</p>`;
        const actions = `<button data-action="restore-msg" data-id="${msg.id}" class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">Restore to Inbox</button>`;
        return createCardHTML(msg, content, actions);
    }

    function renderBlockedSenderCard(user) {
        const date = user.blockedAt ? `Blocked: ${user.blockedAt.toDate().toLocaleString()}` : 'N/A';
        const content = `<div class="flex justify-between items-center"><p class="font-bold text-lg">${user.id}</p><span class="text-xs text-gray-500">${date}</span></div>`;
        const actions = `<button data-action="unblock" data-email="${user.id}" class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">Unblock Sender</button>`;
        return `<div class="item-card p-4">${content}<div class="flex items-center flex-wrap gap-2 mt-2">${actions}</div></div>`;
    }

    // --- Event Listeners & Actions ---
    function addCardEventListeners() {
        document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', (e) => {
                const { action, id, email, type } = e.target.dataset;
                if (action === 'approve') updateRatingStatus(id, { status: 'approved', isAnonymous: false });
                else if (action === 'approve-anon') updateRatingStatus(id, { status: 'approved', isAnonymous: true });
                else if (action === 'reject') updateRatingStatus(id, { status: 'rejected' });
                else if (action === 'retract' || action === 'restore') updateRatingStatus(id, { status: 'pending' });
                else if (action === 'reject-msg') updateMessageStatus(id, 'rejected');
                else if (action === 'restore-msg') updateMessageStatus(id, 'inbox');
                else if (action === 'block' && confirm(`Block ${email}?`)) blockSender(email);
                else if (action === 'unblock' && confirm(`Unblock ${email}?`)) unblockSender(email);
                else if (action === 'respond') openResponseModal({ id, type });
            });
        });
    }

    async function updateRatingStatus(id, payload) { await updateDoc(doc(db, "ratings", id), payload); }
    async function updateMessageStatus(id, status) {
        const payload = { status };
        if (status === 'rejected') payload.rejectedAt = serverTimestamp();
        else if (status === 'inbox') payload.restoredAt = serverTimestamp();
        await updateDoc(doc(db, "messages", id), payload);
    }
    async function blockSender(email) { if(email) await setDoc(doc(db, "blocked_senders", email.toLowerCase()), { blockedAt: serverTimestamp() }); }
    async function unblockSender(email) { if(email) await deleteDoc(doc(db, "blocked_senders", email.toLowerCase())); }

    // --- NEW: Response Modal Logic ---
    function setupModalListeners() {
        document.getElementById('response-cancel-btn').addEventListener('click', closeResponseModal);
        responseForm.addEventListener('submit', handleResponseSubmit);
    }

    function openResponseModal({ id, type }) {
        const sourceData = type === 'message' ? allMessages : allRatings;
        const item = sourceData.find(d => d.id === id);
        if (!item) {
            alert('Error: Could not find the item to respond to.');
            return;
        }
        currentResponseData = { ...item, type };
        document.getElementById('response-recipient-name').textContent = item.name;
        document.getElementById('response-recipient-email').textContent = item.email;
        // Only show public checkbox for approved ratings or any message
        const publicCheckboxContainer = document.getElementById('response-is-public').parentElement;
        publicCheckboxContainer.style.display = (type === 'rating' && item.status === 'approved') || type === 'message' ? 'flex' : 'none';

        responseModalOverlay.classList.add('visible');
    }

    function closeResponseModal() {
        responseModalOverlay.classList.remove('visible');
        responseForm.reset();
        currentResponseData = {};
    }

    async function handleResponseSubmit(e) {
        e.preventDefault();
        const responseText = document.getElementById('response-message').value;
        const isPublic = document.getElementById('response-is-public').checked;

        if (responseText.length < 10) {
            alert("Response must be at least 10 characters long.");
            return;
        }

        const { id, type, name, email, message, comment, rating, isAnonymous } = currentResponseData;
        const collectionName = type === 'message' ? 'messages' : 'ratings';

        try {
            // 1. Update the original document with the response
            await updateDoc(doc(db, collectionName, id), {
                response: responseText,
                respondedAt: serverTimestamp(),
                isPublicResponse: isPublic,
                // NEW: Add a flag to trigger the Cloud Function
                createPublicTestimonial: isPublic ? true : null
            });

            // 2. If public, create a new document in the 'testimonials' collection
            if (isPublic) {
                const testimonialData = {
                    authorName: isAnonymous ? 'Anonymous' : name,
                    originalText: type === 'message' ? message : comment,
                    adminResponse: responseText,
                    createdAt: serverTimestamp(),
                    sourceId: id,
                    sourceType: type
                };
                if (type === 'rating') {
                    testimonialData.rating = rating;
                }
                await addDoc(collection(db, "testimonials"), testimonialData);
            }

            alert("Response sent successfully!");
            closeResponseModal();

        } catch (error) {
            console.error("Error sending response: ", error);
            alert("Failed to send response. Please check the console for errors.");
        }
    }


    // --- Bulk Actions ---
    function setupBulkActionButtons() {
        document.getElementById('messages-bulk-actions').innerHTML = `<button class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Bulk <i class="fa-solid fa-caret-down ml-2"></i></button><div class="bulk-actions-dropdown"><a data-bulk-action="reject-msg">Reject</a><a data-bulk-action="block">Block Sender</a></div>`;
        document.getElementById('ratings-bulk-actions').innerHTML = `<button class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700">Bulk <i class="fa-solid fa-caret-down ml-2"></i></button><div class="bulk-actions-dropdown"><a data-bulk-action="approve">Approve</a><a data-bulk-action="approve-anon">Approve Anon</a><a data-bulk-action="reject">Reject</a><a data-bulk-action="block">Block Sender</a></div>`;
        document.querySelectorAll('.bulk-actions-container button').forEach(btn => btn.addEventListener('click', (e) => e.currentTarget.nextElementSibling.classList.toggle('show-dropdown')));
        document.querySelectorAll('.bulk-actions-dropdown a').forEach(a => a.addEventListener('click', (e) => {
            const action = e.target.dataset.bulkAction;
            const paneId = e.target.closest('.bulk-actions-container').parentElement.parentElement.id;
            handleBulkAction(action, paneId);
            e.target.parentElement.classList.remove('show-dropdown');
        }));
    }

    async function handleBulkAction(action, paneId) {
        const container = document.getElementById(paneId);
        const selected = Array.from(container.querySelectorAll('.bulk-checkbox:checked'));
        if (selected.length === 0) return alert("No items selected.");

        const blockedEmails = allBlockedSenders.map(u => u.id);
        const actions = {
            'reject-msg': { valid: s => s.dataset.status !== 'rejected', fn: id => updateMessageStatus(id, 'rejected') },
            'approve': { valid: s => s.dataset.status === 'pending', fn: id => updateRatingStatus(id, { status: 'approved', isAnonymous: false }) },
            'approve-anon': { valid: s => s.dataset.status === 'pending', fn: id => updateRatingStatus(id, { status: 'approved', isAnonymous: true }) },
            'reject': { valid: s => s.dataset.status !== 'rejected', fn: id => updateRatingStatus(id, { status: 'rejected' }) },
            'block': { valid: s => !blockedEmails.includes(s.dataset.email.toLowerCase()), fn: (id, email) => blockSender(email) },
        };
        const currentAction = actions[action];
        if (!currentAction) return;

        const validSelections = selected.filter(currentAction.valid);
        const invalidCount = selected.length - validSelections.length;

        if (validSelections.length === 0) return alert("No valid items selected for this action.");
        if (!confirm(`Perform '${action}' on ${validSelections.length} items?` + (invalidCount > 0 ? `\n(${invalidCount} invalid items will be skipped)`: ''))) return;

        for (const checkbox of validSelections) await currentAction.fn(checkbox.dataset.id, checkbox.dataset.email);
        alert(`Action completed on ${validSelections.length} items.`);
    }

    // --- Statistics Graph ---
    function renderStatisticsGraph() {
        const ctx = document.getElementById('stats-chart').getContext('2d');
        const dateStart = document.getElementById('stats-date-start').value;
        const dateEnd = document.getElementById('stats-date-end').value;
        const chartType = document.getElementById('stats-chart-type').value;
        const selectedData = Array.from(document.getElementById('stats-data-select').selectedOptions).map(o => o.value);

        const dataMap = {
            messages: { items: allMessages, dateField: 'createdAt', label: 'New Messages', color: 'rgba(54, 162, 235, 0.6)' },
            ratings: { items: allRatings, dateField: 'createdAt', label: 'New CV Ratings', color: 'rgba(255, 206, 86, 0.6)' },
            rejected: { items: allMessages.filter(m => m.status === 'rejected'), dateField: 'rejectedAt', label: 'Rejected Messages', color: 'rgba(255, 99, 132, 0.6)' },
            blocked: { items: allBlockedSenders, dateField: 'blockedAt', label: 'Blocked Senders', color: 'rgba(75, 192, 192, 0.6)' },
        };

        const datasets = selectedData.map(key => {
            const source = dataMap[key];
            const data = source.items.filter(item => item[source.dateField] && dateInRange(item[source.dateField].toDate().toISOString().split('T')[0], dateStart, dateEnd)).length;
            return { label: source.label, data: [data], backgroundColor: source.color };
        });

        if (statsChart) statsChart.destroy();
        statsChart = new Chart(ctx, {
            type: chartType,
            data: { labels: ['Selected Range'], datasets: datasets },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { position: 'top' } } }
        });
    }

    window.onclick = function(event) { if (!event.target.matches('.bulk-actions-container button, .bulk-actions-container i')) { document.querySelectorAll(".bulk-actions-dropdown.show-dropdown").forEach(d => d.classList.remove('show-dropdown')); } }
</script>
</body>
</html>
